# Datapace Proxy
Proxy service is part of [Datapace](datapace.com) infrastructure.The purpose of service is to act as reverse proxy between subscriber(the user who buy the stream subscription) and stream source (the user who is providing/selling the stream) in [Datapace](datapace.com) system.

## How It Works
The service provides one HTTP API end point for route registration

| Method       | URL                                |Payload             | Required |          
|--------------|---------------------------------------------------------|----------|----------|
| POST         | `/api/register`                    | ```{'ttl': Integer, url: String}```| Yes |

Payload Description

`url` - Represents the ***actual stream source URL*** (the URL which is provided by stream owner) which we need to proxy.

`ttl` - Represents the actual proxy route ***time to leave in hours***. It depends of subscription time (how long you subscription is active in hours).

After new route registration, the service will generate random route path for this new route and JWT token, save this data to internal storage and return newly generated URL which us actually a stream end point URL which will be given to consumer (stream subscriber/buyer).

Request Example:
```
curl -H "Content-Type: application/json" -X POST -d '{"url":"http://jsonplaceholder.typicode.com/posts/1","ttl":1}' http://localhost:8088/api/register

```

Response example:

```
{
    "url":"http://localhost:8081/e7bf705bcc317d19737c34f54d6ba800?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbmREYXRlIjoiMjAxNy0xMi0yNlQxMTo0ODoyMS44MDhaIiwicGF0aCI6ImU3YmY3MDViY2MzMTdkMTk3MzdjMzRmNTRkNmJhODAwIiwiaXNzdWVyIjoiTW9uZXRhc2EiLCJpYXQiOjE1MTQyODUzMDEsImV4cCI6MTUxNDI4ODkwMX0.T-AERFFi1jT9Xa8CZ3McMzLojll8uqNSOc-CAHp-pB8"
}
```

```
/e7bf705bcc317d19737c34f54d6ba800
```
- Is a random unique route path

```
token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbmREYXRlIjoiMjAxNy0xMi0yNlQxMTo0ODoyMS44MDhaIiwicGF0aCI6ImU3YmY3MDViY2MzMTdkMTk3MzdjMzRmNTRkNmJhODAwIiwiaXNzdWVyIjoiTW9uZXRhc2EiLCJpYXQiOjE1MTQyODUzMDEsImV4cCI6MTUxNDI4ODkwMX0.T-AERFFi1jT9Xa8CZ3McMzLojll8uqNSOc-CAHp-pB8
```
- Is a consumer JWT token.

With this consumer URL you have access to real stream source (provided by stream owner) until your subscription is valid. In our example you will have access to http://jsonplaceholder.typicode.com/posts/1 for a 1 hour.

## Requirements

You'll need the following software installed to get started.

  - [Node.js](http://nodejs.org): Version 8.x. Use the installer for your OS.
  - [Git](http://git-scm.com/downloads): Use the installer for your OS.
    - Windows users can also try [Git for Windows](http://git-for-windows.github.io/).
  - [Redis](https://redis.io/) - Only for local setup (if you don't use docker-compose).
  - [Docker](https://docs.docker.com/engine/installation/) Use the installer for your OS.
  - [docker-compose](https://docs.docker.com/compose/install/#install-compose) Use the installer for your OS.

## Get Started

Clone this repository

```bash
git clone git@gitlab.com:drasko/datapace-proxy.git
```

Change into the directory.

```bash
cd datapace-proxy
```

Install the dependencies. If you're running Mac OS or Linux, you may need to run `sudo npm install` instead, depending on how your machine is configured.

```bash
npm install
```

Set environment variable for public access (public URL generated by proxy)
```
export PUBLIC_URL=the_url_where_service_is_running
```
If environment variable is not set, the default value will be `http://localhost:8081`


To start the server, run:

```bash
npm start
```
This will run the service.
 **Managment  API (for route registration) is available on `localhost:8088`** and **proxy is available on `localhost:8087`**

## Using Docker
The service is fully containerized, [docker-compose](https://docs.docker.com/compose/) is responsible to spin composition.
```bash
docker-compose up -d
```

## Contribution
* Please use pull requests.
* Issues, Please Submit issue following [Github report template](https://gist.github.com/carlo/3402842) guidline.
* Project code is written with [ES6](http://es6-features.org/#Constants) the latest standard.
* Project uses [ESlint](https://eslint.org/) for code linting, predefined with [google best practice rules](https://github.com/google/eslint-config-google).

NOTE: Please follow those rules, otherwise your pull request will be rejected.
